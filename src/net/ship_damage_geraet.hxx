#ifndef SHIP_DAMAGE_GERAET_HXX_
#define SHIP_DAMAGE_GERAET_HXX_

/**
 * @file
 * @author Jason Lingle
 * @date 2012.03.09
 * @brief Contains the ShipDamageGeraet class
 */

#include <map>

#include "async_ack_geraet.hxx"
#include "network_geraet.hxx"

class Ship;
class Blast;

/**
 * Sends notifications of Ship-Blast collisions to remote ship owners, and
 * also receives them.
 *
 * One of these exists per NetworkConnection. When a remote ship is imported,
 * the SDG of that connection is associated with the ship. Then, when the ship
 * hits a Blast, it forwards the information to the remote peer by calling
 * shipBlastCollision().
 *
 * Ships being exported are registered/deregistered with this via the
 * autogenerated ENO_Ship class; the Ship class itself does not know about the
 * way this class handles incomming damage information.
 */
class ShipDamageGeraet: public ReliableSender, public AAGReceiver {
  std::map<const Ship*, NetworkConnection::channel> remoteShips;
  std::map<NetworkConnection::channel, Ship*> localShips;

public:
  static const NetworkConnection::geraet_num num;

  /**
   * Constructs an SDG using the given AAG.
   */
  ShipDamageGeraet(AsyncAckGeraet*);

  /**
   * Called by a remote Ship to notify the appropriate peer of damage.
   */
  void shipBlastCollision(const Ship*, const Blast*) throw();

  /**
   * Associates the given (imported) Ship with the incomming channel that
   * controls it.
   */
  void addRemoteShip(const Ship*, NetworkConnection::channel) throw();
  /**
   * Removes the associated involving the given (imported) Ship.
   */
  void delRemoteShip(const Ship*) throw();

  /**
   * Associates the given (exported) Ship with its outgoing channel on the
   * connection this SDG is associated with.
   */
  void addLocalShip(NetworkConnection::channel, Ship*) throw();
  /**
   * Removes the associated outgoing channel-exported Ship pairing specified.
   */
  void delLocalShip(NetworkConnection::channel) throw();

protected:
  virtual void receiveAccepted(NetworkConnection::seq_t, const byte*, unsigned)
  throw();

private:
  static InputNetworkGeraet* create(NetworkConnection*) throw();
};

#endif /* SHIP_DAMAGE_GERAET_HXX_ */
